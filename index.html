<!DOCTYPE html>
<html lang="zh-CN">
<head>
<link rel="icon" href="https://cdn-icons-png.flaticon.com/16/2534/2534026.png" type="image/png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>数字猜猜乐</title>
  <!-- 引入外部资源 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.0/dist/av-min.js"></script>
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6366F1',
            secondary: '#EC4899',
            accent: '#10B981',
            neutral: '#1F2937',
            danger: '#EF4444',
            warning: '#F59E0B',
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
          animation: {
            'bounce-slow': 'bounce 2s infinite',
            'float': 'float 3s ease-in-out infinite',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            }
          }
        },
      }
    }
  </script>
  
  <!-- 自定义工具类和样式 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .glass-effect {
        backdrop-filter: blur(12px);
        background-color: rgba(255, 255, 255, 0.85);
      }
      .glass-effect-dark {
        backdrop-filter: blur(12px);
        background-color: rgba(30, 41, 59, 0.85);
      }
      .card-shadow {
        box-shadow: 0 10px 25px -5px rgba(99, 102, 241, 0.08), 0 8px 10px -6px rgba(99, 102, 241, 0.08);
      }
      .card-shadow-dark {
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.2);
      }
    }
  </style>
  
  <style>

/* 精准选中管理员页面用户列表的用户名文字 */
.dark-theme #user-list .flex.items-center.gap-2 > span,
.dark-theme #user-list .flex.items-center.gap-2 > span > span, /* 包含用户名和标签的外层span */
.dark-theme #user-list .text-xs.bg-primary\/10, /* 管理员标签 */
.dark-theme #user-list .text-xs.bg-gray-100 { /* 普通用户标签 */
  color: #ffffff !important; /* 强制白色 */
  opacity: 1 !important; /* 完全不透明，确保清晰可见 */
}

/* 修复用户列表项背景与文字对比度 */
.dark-theme #user-list .flex.justify-between.items-center {
  background-color: rgba(55, 65, 81, 0.6) !important; /* 加深背景，凸显白色文字 */
}

/* 管理员页面 - 用户列表用户名白色适配 */
.dark-theme #user-list .user-item span,
.dark-theme #user-list .flex items-center gap-2 span,
.dark-theme #user-list .text-xs, /* 管理员/普通用户标签文字 */
.dark-theme #current-user-records-title, /* 战绩标题 */
.dark-theme #user-records .record-stats span, /* 战绩列表文字 */
.dark-theme #search-user::placeholder, /* 搜索框占位符 */
.dark-theme #admin-self-password::placeholder, /* 管理员改密码输入框 */
.dark-theme #add-admin-username::placeholder { /* 添加管理员输入框 */
  color: #ffffff !important;
  opacity: 0.95 !important;
}

/* 管理员页面标签背景提亮（配合白色文字） */
.dark-theme #user-list .text-xs.bg-primary\/10,
.dark-theme #user-list .text-xs.bg-gray-100 {
  background-color: rgba(165, 180, 252, 0.2) !important; /* 管理员标签背景提亮 */
  color: #ffffff !important; /* 标签文字白色 */
}

/* 深色模式适配：全部字体+图形改为白色/亮色 */
.dark-theme .text-gray-700,
.dark-theme .text-gray-600,
.dark-theme .text-gray-500,
.dark-theme .text-gray-400,
.dark-theme .text-neutral, /* 中性色文字改为白色 */
.dark-theme .footer-text,
.dark-theme .record-date,
.dark-theme .record-stats,
.dark-theme h1, .dark-theme h2, .dark-theme h3, .dark-theme h4, .dark-theme h5, .dark-theme h6,
.dark-theme button span,
.dark-theme input::placeholder,
.dark-theme input, /* 输入框文字 */
.dark-theme .difficulty-text,
.dark-theme .result-message,
.dark-theme #username-display,
.dark-theme .auth-form p,
.dark-theme #current-user-records-title,
.dark-theme #search-user::placeholder {
  color: #ffffff !important; /* 所有文字统一为白色 */
  opacity: 0.95 !important; /* 适当提高不透明度，避免过暗 */
}

/* 图标（FontAwesome）统一改为白色亮色 */
.dark-theme .fa,
.dark-theme .fa-user,
.dark-theme .fa-sign-in,
.dark-theme .fa-user-plus,
.dark-theme .fa-key,
.dark-theme .fa-cog,
.dark-theme .fa-bar-chart,
.dark-theme .fa-moon-o,
.dark-theme .fa-sun-o,
.dark-theme .fa-question-circle,
.dark-theme .fa-sign-out,
.dark-theme .fa-times,
.dark-theme .fa-search,
.dark-theme .fa-refresh,
.dark-theme .fa-list-ul,
.dark-theme .fa-check-circle,
.dark-theme .fa-trophy,
.dark-theme .fa-times-circle,
.dark-theme .fa-trash-o,
.dark-theme .fa-history,
.dark-theme .fa-star,
.dark-theme .fa-clock-o,
.dark-theme .fa-signal {
  color: #ffffff !important; /* 所有图标统一为白色 */
  opacity: 0.95 !important;
}

/* 特殊状态文字保留原有颜色（但提亮） */
.dark-theme .record-success {
  color: #34d399 !important; /* 胜利绿色提亮 */
}
.dark-theme .record-fail {
  color: #f87171 !important; /* 失败红色提亮 */
}
.dark-theme .text-red-500 {
  color: #fca5a5 !important; /* 错误提示红色提亮 */
}
.dark-theme .text-green-500 {
  color: #4ade80 !important; /* 成功提示绿色提亮 */
}
.dark-theme .text-primary {
  color: #a5b4fc !important; /* 主色调提亮（原#6366F1） */
}
.dark-theme .text-secondary {
  color: #f9a8d4 !important; /* 辅助色提亮（原#EC4899） */
}

/* 输入框、边框等元素提亮，适配白色文字 */
.dark-theme .border-gray-200 {
  border-color: #4b5563 !important; /* 边框提亮 */
}
.dark-theme input {
  background-color: rgba(55, 65, 81, 0.6) !important; /* 输入框背景加深，凸显白色文字 */
  border-color: #6b7280 !important;
}
.dark-theme input:focus {
  box-shadow: 0 0 0 3px rgba(165, 180, 252, 0.4) !important; /* 聚焦边框提亮 */
}

/* 猜测历史项文字颜色（深色模式下白色） */
.dark-theme #guess-history span {
  color: #ffffff !important;
  background-color: rgba(75, 85, 99, 0.5) !important;
}

/* 1. 全局基础自适应（优先添加，作用于所有元素） */
* {
  box-sizing: border-box; /* 避免padding撑大元素 */
  margin: 0;
  padding: 0;
}

/* 2. 视口适配优化（确保meta标签已正确设置，原代码已包含，无需改动） */
/* 原代码：<meta name="viewport" content="width=device-width, initial-scale=1.0"> */

/* 3. 字体大小自适应（用vw单位，跟随屏幕宽度变化） */
/* 替换原固定font-size，如14px→2.8vw，16px→3.2vw */
body {
  font-size: clamp(14px, 3vw, 18px) !important; /* 最小14px，最大18px，按屏幕3%自适应 */
}

/* 标题文字自适应 */
h1, .header-title {
  font-size: clamp(1.5rem, 6vw, 2.2rem) !important; /* 标题更大，适配屏幕 */
}
h2, h3, .text-lg {
  font-size: clamp(1.1rem, 4.5vw, 1.6rem) !important;
}
h4, h5 {
  font-size: clamp(1rem, 3.8vw, 1.3rem) !important;
}

/* 按钮、小文字自适应 */
button span, .btn-text {
  font-size: clamp(0.9rem, 3.5vw, 1.1rem) !important;
}
.text-sm, .record-date, .footer-text, input::placeholder {
  font-size: clamp(0.8rem, 3vw, 1rem) !important;
}

/* 4. 图形/容器大小自适应（替换原固定px为vw或clamp） */
/* 游戏卡片、弹窗等容器 */
#game-card, #rules-card, .glass-effect, .glass-effect-dark, 
#auth-modal .glass-effect, #records-modal .glass-effect, #success-modal .glass-effect {
  max-width: 95vw !important; /* 最大宽度占屏幕95% */
  padding: clamp(1rem, 5vw, 1.8rem) !important; /* 内边距自适应 */
  margin: 0 auto !important;
}

/* 图标大小自适应 */
.fa {
  font-size: clamp(1rem, 3.5vw, 1.3rem) !important;
}
/* 圆形图标容器（如登录/胜利弹窗的图标区） */
.w-16.h-16 {
  width: clamp(4rem, 12vw, 5rem) !important;
  height: clamp(4rem, 12vw, 5rem) !important;
}

/* 按钮大小自适应 */
button {
  padding: clamp(0.8rem, 3vw, 1.2rem) !important;
  border-radius: clamp(0.5rem, 2vw, 0.8rem) !important;
}
/* 输入框自适应 */
input {
  padding: clamp(0.8rem, 3vw, 1.2rem) !important;
  border-radius: clamp(0.5rem, 2vw, 0.8rem) !important;
  font-size: clamp(0.9rem, 3.2vw, 1.1rem) !important;
}

/* 猜测历史项自适应 */
#guess-history span {
  padding: clamp(0.5rem, 2vw, 0.8rem) clamp(1rem, 3vw, 1.5rem) !important;
  font-size: clamp(0.85rem, 3vw, 1rem) !important;
  margin: 0.2rem !important;
}

/* 管理员面板元素自适应 */
#admin-panel .glass-effect {
  max-width: 95vw !important;
  max-height: 85vh !important;
  padding: clamp(1rem, 4vw, 1.5rem) !important;
}
#user-list, #user-records, #records-list {
  max-height: clamp(10rem, 30vw, 15rem) !important;
}
/* 战绩记录样式调整 */
#user-records {
  padding: 1rem;
  border-radius: 0.75rem;
  background-color: rgba(255, 255, 255, 0.5);
  border: 1px solid rgba(229, 231, 235, 0.5);
}

.dark-theme #user-records {
  background-color: rgba(55, 65, 81, 0.3);
  border-color: rgba(75, 85, 99, 0.5);
}

.record-item {
  padding: 0.75rem;
  border-radius: 0.5rem;
  margin-bottom: 0.5rem;
  background-color: rgba(255, 255, 255, 0.8);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  transition: transform 0.2s ease;
}

.dark-theme .record-item {
  background-color: rgba(31, 41, 55, 0.8);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.record-item:hover {
  transform: translateY(-2px);
}

.record-item .record-date {
  font-size: 0.75rem;
  color: #6b7280;
  margin-bottom: 0.25rem;
}

.dark-theme .record-item .record-date {
  color: #9ca3af;
}

.record-item .record-stats {
  display: flex;
  justify-content: space-between;
  font-size: 0.875rem;
}

.record-item .record-success {
  color: #10b981; /* 胜利用绿色 */
}

.record-item .record-fail {
  color: #ef4444; /* 失败用红色 */
}
    /* 基础样式 */
    body {
      background: #ffffff;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
      transition: background-color 0.5s ease;
    }
    
    body.dark-theme {
      background: #1a202c;
    }
    
    /* 输入框样式 */
    input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }
    
    /* 动画效果 */
    .number-animation {
      transition: all 0.3s ease;
    }
    
    .result-animation {
      animation: fadeIn 0.5s ease forwards;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .theme-transition {
      transition: all 0.5s ease;
    }
    
    .password-modal-enter {
      animation: modalEnter 0.3s ease forwards;
    }
    
    @keyframes modalEnter {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    
    .remaining-count-area {
      transition: color 0.3s ease, background-color 0.3s ease;
    }
    
    /* 深色模式适配 - 修复图标颜色 */
    .dark-theme .text-gray-700 { color: #e2e8f0 !important; }
    .dark-theme .text-gray-600 { color: #cbd5e1 !important; }
    .dark-theme .text-gray-500 { color: #94a3b8 !important; }
    .dark-theme .text-gray-400 { color: #94a3b8 !important; }
    .dark-theme .border-gray-200 { border-color: #475569 !important; }
    .dark-theme .bg-white\/60 { background-color: rgba(30, 41, 59, 0.6) !important; }
    .dark-theme .bg-gray-100\/70 { background-color: rgba(51, 65, 85, 0.7) !important; }
    .dark-theme .bg-gray-200\/70 { background-color: rgba(71, 85, 105, 0.7) !important; }
    .dark-theme .header-title { color: #f8fafc !important; }
    .dark-theme .footer-text { color: #94a3b8 !important; }
    .dark-theme .fa { color: #e2e8f0 !important; } /* 深色模式下所有图标颜色 */
    
    /* 难度开关样式 */
    .difficulty-switch {
      position: relative;
      display: inline-block;
      width: 56px;
      height: 28px;
    }
    
    .difficulty-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .difficulty-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #e5e7eb;
      transition: .3s;
      border-radius: 28px;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .difficulty-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    
    input:checked + .difficulty-slider {
      background-color: #EF4444;
    }
    
    input:checked + .difficulty-slider:before {
      transform: translateX(28px);
    }
    
    .dark-theme .difficulty-slider {
      background-color: #4b5563;
    }
    
    .dark-theme input:checked + .difficulty-slider {
      background-color: #f87171;
    }
    
    /* 平滑滚动 */
    html {
      scroll-behavior: smooth;
    }
  </style>
</head>
<body class="font-inter text-neutral min-h-screen flex flex-col theme-transition">
  <!-- 登录/注册弹窗 -->
  <div id="auth-modal" class="fixed inset-0 bg-black/20 flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="glass-effect rounded-2xl p-8 max-w-md w-full mx-4 password-modal-enter card-shadow">
      <!-- 登录表单 -->
      <div id="login-form" class="auth-form">
        <div class="text-center mb-6">
          <div class="w-16 h-16 bg-primary/20 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fa fa-user-circle text-2xl text-primary"></i>
          </div>
          <h3 class="text-xl font-bold text-neutral mb-2 theme-transition">用户登录</h3>
          <p class="text-gray-600 text-sm theme-transition">欢迎回来，请登录您的账号</p>
        </div>
        
        <div class="space-y-4 mb-6">
          <div>
            <input 
              type="text" 
              id="login-username" 
              placeholder="请输入用户名"
              class="w-full px-4 py-3 rounded-lg border border-gray-200 bg-white/60 text-neutral focus:border-primary transition-all duration-200 theme-transition"
              required
            >
          </div>
          <div>
            <input 
              type="password" 
              id="login-password" 
              placeholder="请输入密码"
              class="w-full px-4 py-3 rounded-lg border border-gray-200 bg-white/60 text-neutral focus:border-primary transition-all duration-200 theme-transition"
              required
            >
          </div>
          <div>
            <p id="login-error" class="text-red-500 text-sm text-center hidden theme-transition"></p>
          </div>
        </div>
        
        <button 
          id="login-btn" 
          class="w-full py-3 bg-primary hover:bg-primary/90 text-white px-6 rounded-lg transition-all duration-200 flex items-center justify-center shadow-md hover:shadow-primary/30 theme-transition"
        >
          <i class="fa fa-sign-in mr-2"></i>
          <span>登录</span>
        </button>
        
        <div class="text-center mt-4 text-sm text-gray-600 theme-transition">
          还没有账号？<a href="javascript:;" id="switch-to-register" class="text-primary hover:underline">立即注册</a>
        </div>
      </div>
      
      <!-- 注册表单 -->
      <div id="register-form" class="auth-form hidden">
        <div class="text-center mb-6">
          <div class="w-16 h-16 bg-secondary/20 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fa fa-user-plus text-2xl text-secondary"></i>
          </div>
          <h3 class="text-xl font-bold text-neutral mb-2 theme-transition">用户注册</h3>
          <p class="text-gray-600 text-sm theme-transition">创建新账号，开始游戏之旅</p>
        </div>
        
        <div class="space-y-4 mb-6">
          <div>
            <input 
              type="text" 
              id="register-username" 
              placeholder="请设置用户名"
              class="w-full px-4 py-3 rounded-lg border border-gray-200 bg-white/60 text-neutral focus:border-primary transition-all duration-200 theme-transition"
              required
            >
          </div>
          <div>
            <input 
              type="password" 
              id="register-password" 
              placeholder="请设置密码（至少6位）"
              class="w-full px-4 py-3 rounded-lg border border-gray-200 bg-white/60 text-neutral focus:border-primary transition-all duration-200 theme-transition"
              minlength="6"
              required
            >
          </div>
          <div>
            <input 
              type="password" 
              id="register-confirm-password" 
              placeholder="请确认密码"
              class="w-full px-4 py-3 rounded-lg border border-gray-200 bg-white/60 text-neutral focus:border-primary transition-all duration-200 theme-transition"
              required
            >
          </div>
          <div>
            <p id="register-error" class="text-red-500 text-sm text-center hidden theme-transition"></p>
            <p id="register-success" class="text-green-500 text-sm text-center hidden theme-transition"></p>
          </div>
        </div>
        
        <button 
          id="register-btn" 
          class="w-full py-3 bg-secondary hover:bg-secondary/90 text-white px-6 rounded-lg transition-all duration-200 flex items-center justify-center shadow-md hover:shadow-secondary/30 theme-transition"
        >
          <i class="fa fa-user-plus mr-2"></i>
          <span>注册</span>
        </button>
        
        <div class="text-center mt-4 text-sm text-gray-600 theme-transition">
          已有账号？<a href="javascript:;" id="switch-to-login" class="text-primary hover:underline">返回登录</a>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 修改密码弹窗 -->
  <div id="change-password-modal" class="fixed inset-0 bg-black/20 flex items-center justify-center z-50 hidden backdrop-blur-sm theme-transition">
    <div class="glass-effect rounded-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="change-password-content">
      <div class="flex justify-between items-start mb-4">
        <h3 class="text-xl font-bold text-neutral flex items-center gap-2 theme-transition">
          <i class="fa fa-key text-primary"></i>
          修改密码
        </h3>
        <button id="close-password-modal" class="text-gray-400 hover:text-gray-600 transition-colors theme-transition">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <input type="hidden" id="target-user-id">
      <div class="space-y-4 mb-6">
        <div>
          <input 
            type="password" 
            id="new-password" 
            placeholder="请输入新密码（至少6位）"
            class="w-full px-4 py-3 rounded-lg border border-gray-200 bg-white/60 text-neutral focus:border-primary transition-all duration-200 theme-transition"
            minlength="6"
            required
          >
        </div>
        <div>
          <input 
            type="password" 
            id="confirm-new-password" 
            placeholder="请确认新密码"
            class="w-full px-4 py-3 rounded-lg border border-gray-200 bg-white/60 text-neutral focus:border-primary transition-all duration-200 theme-transition"
            required
          >
        </div>
        <div>
          <p id="password-error" class="text-red-500 text-sm text-center hidden theme-transition"></p>
        </div>
      </div>
      <button id="save-password-btn" class="w-full py-3 bg-primary hover:bg-primary/90 text-white rounded-lg transition-all duration-200 shadow-md hover:shadow-primary/30 theme-transition">
        保存密码
      </button>
    </div>
  </div>
  
  <!-- 管理员管理页面 -->
  <div id="admin-panel" class="fixed inset-0 bg-black/30 flex items-center justify-center z-50 backdrop-blur-sm hidden">
    <div class="glass-effect rounded-2xl p-8 max-w-3xl w-full mx-4 card-shadow theme-transition max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-start mb-6">
        <h3 class="text-xl font-bold text-neutral flex items-center gap-2 theme-transition">
          <i class="fa fa-cog text-primary"></i>
          管理员面板
        </h3>
        <button id="close-admin-panel" class="text-gray-400 hover:text-gray-600 transition-colors theme-transition">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <!-- 新增：管理员功能区域 -->
      <div class="mb-6 p-4 bg-blue-50/50 dark:bg-blue-900/20 rounded-lg">
        <h4 class="text-lg font-medium text-neutral mb-3 flex items-center gap-2 theme-transition">
          <i class="fa fa-shield text-primary"></i>
          管理员功能
        </h4>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- 修改自身密码 -->
          <div class="p-3 bg-white/60 dark:bg-gray-800/60 rounded-lg">
            <h5 class="font-medium text-neutral mb-2 theme-transition">修改我的密码</h5>
            <div class="flex gap-2">
              <input 
                type="password" 
                id="admin-self-password" 
                placeholder="新密码（至少6位）"
                class="flex-1 px-3 py-2 rounded-lg border border-gray-200 bg-white/60 text-neutral text-sm focus:border-primary transition-all duration-200 theme-transition"
                minlength="6"
              >
              <button 
                id="change-self-password-btn"
                class="px-4 py-2 bg-primary hover:bg-primary/90 text-white rounded-lg transition-all duration-200 text-sm"
              >
                修改
              </button>
            </div>
            <p id="self-password-error" class="text-red-500 text-xs mt-1 hidden theme-transition"></p>
          </div>
          
          <!-- 添加管理员权限 -->
          <div class="p-3 bg-white/60 dark:bg-gray-800/60 rounded-lg">
            <h5 class="font-medium text-neutral mb-2 theme-transition">添加管理员</h5>
            <div class="flex gap-2">
              <input 
                type="text" 
                id="add-admin-username" 
                placeholder="输入用户名"
                class="flex-1 px-3 py-2 rounded-lg border border-gray-200 bg-white/60 text-neutral text-sm focus:border-primary transition-all duration-200 theme-transition"
              >
              <button 
                id="add-admin-btn"
                class="px-4 py-2 bg-secondary hover:bg-secondary/90 text-white rounded-lg transition-all duration-200 text-sm"
              >
                添加
              </button>
            </div>
            <p id="add-admin-error" class="text-red-500 text-xs mt-1 hidden theme-transition"></p>
            <p id="add-admin-success" class="text-green-500 text-xs mt-1 hidden theme-transition"></p>
          </div>
        </div>
      </div>
      
      <!-- 搜索用户 -->
      <div class="mb-6">
        <input 
          type="text" 
          id="search-user" 
          placeholder="搜索用户..."
          class="w-full px-4 py-3 rounded-lg border border-gray-200 bg-white/60 text-neutral focus:border-primary transition-all duration-200 theme-transition"
        >
      </div>
      
      <!-- 用户列表 -->
      <div class="mb-6">
        <h4 class="text-lg font-medium text-neutral mb-3 theme-transition">用户管理</h4>
        <div id="user-list" class="max-h-60 overflow-y-auto space-y-3">
          <p class="text-gray-500 text-center py-4 theme-transition">加载用户中...</p>
        </div>
      </div>
      
      <!-- 用户战绩 -->
      <div>
        <h4 class="text-lg font-medium text-neutral mb-3 theme-transition">
          <span id="current-user-records-title">用户战绩</span>
        </h4>
        <div id="user-records" class="max-h-60 overflow-y-auto space-y-3">
          <p class="text-gray-500 text-center py-4 theme-transition">请选择一个用户查看战绩</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 顶部导航 -->
  <header class="w-full py-4 px-6 glass-effect sticky top-0 z-10 transition-all duration-300 shadow-sm theme-transition" id="header" style="display: none;">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-primary flex items-center header-title theme-transition">
        <i class="fa fa-gamepad mr-2 text-secondary animate-bounce-slow"></i>
        <span></span>
      </h1>
      <div class="flex items-center gap-3">
        <span class="bg-primary/10 text-primary px-4 py-1 rounded-full text-sm font-medium theme-transition">
          欢迎，<span id="username-display">游客</span>
        </span>
        
        <!-- 管理员按钮 -->
        <button id="admin-btn" class="p-2 rounded-full hover:bg-gray-100/50 transition-colors duration-200 theme-transition hidden">
          <i class="fa fa-cog text-neutral"></i>
        </button>
        
        <!-- 战绩按钮 - 修复点击事件 -->
        <button id="records-btn" class="p-2 rounded-full hover:bg-gray-100/50 transition-colors duration-200 theme-transition">
          <i class="fa fa-bar-chart text-neutral"></i>
        </button>
        
        <!-- 主题切换 -->
        <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100/50 transition-colors duration-200 theme-transition">
          <i class="fa fa-moon-o text-neutral"></i>
        </button>
        
        <!-- 帮助按钮 -->
        <button id="help-btn" class="p-2 rounded-full hover:bg-gray-100/50 transition-colors duration-200 theme-transition">
          <i class="fa fa-question-circle text-neutral"></i>
        </button>
        
        <!-- 退出登录 -->
        <button id="logout-btn" class="p-2 rounded-full hover:bg-gray-100/50 transition-colors duration-200 theme-transition">
          <i class="fa fa-sign-out text-neutral"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="flex-grow container mx-auto px-4 py-8 md:py-16 flex flex-col items-center justify-center relative z-20" style="display: none;">
    <!-- 游戏卡片 -->
    <div id="game-card" class="w-full max-w-md glass-effect rounded-2xl card-shadow p-6 md:p-8 theme-transition">
      <!-- 游戏信息 -->
      <div class="mb-6">
        <h2 class="text-lg font-semibold text-neutral mb-2 theme-transition">猜数字游戏</h2>
        <p class="text-gray-600 text-sm theme-transition">我已经想好了一个 <span class="font-bold text-primary">1-100</span> 之间的数字，来猜猜看吧！</p>
      </div>
      
      <!-- 难度设置 -->
      <div class="flex items-center justify-between mb-6 p-3 bg-gray-50/50 rounded-lg theme-transition">
        <span class="text-sm text-gray-600 theme-transition">
          <i class="fa fa-signal mr-1"></i> 难度: <span id="difficulty-text" class="font-medium">普通</span>
        </span>
        <label class="difficulty-switch">
          <input type="checkbox" id="difficulty-toggle" class="theme-transition">
          <span class="difficulty-slider theme-transition"></span>
        </label>
      </div>
      
      <!-- 猜测次数 + 剩余次数 -->
      <div class="flex justify-between items-center gap-3 mb-6">
        <div class="bg-primary/10 rounded-full px-4 py-2 flex items-center theme-transition">
          <i class="fa fa-history text-primary mr-2"></i>
          <span class="text-primary font-medium theme-transition">猜测次数: <span id="guess-count" class="font-bold">0</span></span>
        </div>
        <div id="remaining-count-area" class="bg-danger/10 rounded-full px-4 py-2 flex items-center remaining-count-area theme-transition">
          <i id="remaining-icon" class="fa fa-clock-o text-danger mr-2 theme-transition"></i>
          <span id="remaining-text" class="text-danger font-medium theme-transition">剩余次数: <span id="remaining-count" class="font-bold">10</span></span>
        </div>
      </div>
      
      <!-- 输入区域 -->
      <div class="mb-6">
        <div class="flex gap-3">
          <input 
            type="number" 
            id="guess-input" 
            min="1" 
            max="100" 
            placeholder="输入1-100之间的数字"
            class="flex-grow px-4 py-3 rounded-lg border border-gray-200 bg-white/60 text-neutral focus:border-primary transition-all duration-200 theme-transition"
          >
          <button 
            id="guess-btn" 
            class="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-lg transition-all duration-200 flex items-center justify-center shadow-md hover:shadow-primary/30 theme-transition"
          >
            <i class="fa fa-search mr-2"></i>
            <span>猜</span>
          </button>
        </div>
      </div>
      
      <!-- 结果提示 -->
      <div id="result-container" class="mb-6 h-12 flex items-center justify-center">
        <div id="result-message" class="text-center px-4 py-2 rounded-lg result-animation hidden theme-transition"></div>
      </div>
      
      <!-- 历史记录 -->
      <div class="mb-6">
        <h3 class="text-sm font-medium text-gray-500 mb-2 flex items-center theme-transition">
          <i class="fa fa-list-ul mr-1"></i> 猜测历史
        </h3>
        <div id="guess-history" class="flex flex-wrap gap-2 min-h-[40px] items-center justify-center">
          <span class="text-gray-400 text-sm theme-transition">暂无猜测记录</span>
        </div>
      </div>
      
      <!-- 重置按钮 -->
      <button 
        id="reset-btn" 
        class="w-full py-3 bg-gray-100/70 hover:bg-gray-200/70 text-neutral rounded-lg transition-all duration-200 flex items-center justify-center gap-2 shadow-sm theme-transition"
      >
        <i class="fa fa-refresh"></i>
        <span>重置游戏</span>
      </button>
    </div>
    
    <!-- 游戏规则卡片 -->
    <div id="rules-card" class="w-full max-w-md glass-effect rounded-2xl card-shadow p-6 md:p-8 mt-8 transform transition-all duration-300 hover:shadow-lg hidden theme-transition">
      <div class="flex justify-between items-start mb-4">
        <h3 class="text-lg font-semibold text-neutral flex items-center gap-2 theme-transition">
          <i class="fa fa-info-circle text-primary"></i>
          游戏规则
        </h3>
        <button id="close-rules" class="text-gray-400 hover:text-gray-600 transition-colors theme-transition">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div class="space-y-3 text-gray-600 text-sm theme-transition">
        <p><i class="fa fa-check-circle text-accent mr-2"></i> 系统会随机生成一个1-100之间的数字</p>
        <p><i class="fa fa-check-circle text-accent mr-2"></i> 普通模式有10次猜测机会，困难模式有5次机会</p>
        <p><i class="fa fa-check-circle text-accent mr-2"></i> 每次猜测后会提示"太大"或"太小"</p>
        <p><i class="fa fa-check-circle text-accent mr-2"></i> 猜对数字或用完次数后游戏结束</p>
        <p><i class="fa fa-check-circle text-accent mr-2"></i> 可以随时重置游戏开始新的一轮</p>
      </div>
    </div>
  </main>

  <!-- 页脚 -->
  <footer class="w-full py-6 px-4 glass-effect mt-8 relative z-20 theme-transition" id="footer" style="display: none;">
    <div class="container mx-auto text-center text-gray-500 text-sm footer-text theme-transition">
      <p>© 2025 数字猜猜乐</p>
      <p class="mt-1">
        问题反馈微信:xswllcx
      </p>
    </div>
  </footer>

  <!-- 胜利弹窗 -->
  <div id="success-modal" class="fixed inset-0 bg-black/20 flex items-center justify-center z-50 hidden backdrop-blur-sm theme-transition">
    <div class="glass-effect rounded-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
      <div class="text-center">
        <div class="w-16 h-16 bg-accent/20 rounded-full flex items-center justify-center mx-auto mb-4 theme-transition">
          <i class="fa fa-trophy text-2xl text-accent animate-bounce-slow"></i>
        </div>
        <h3 class="text-xl font-bold text-neutral mb-2 theme-transition">恭喜你猜对了！</h3>
        <p class="text-gray-600 mb-6 theme-transition">你总共猜了 <span id="final-count" class="font-bold text-primary">0</span> 次</p>
        <div class="flex gap-3">
          <button id="play-again-btn" class="flex-1 py-3 bg-primary hover:bg-primary/90 text-white rounded-lg transition-all duration-200 shadow-md hover:shadow-primary/30 theme-transition">
            再玩一次
          </button>
          <button id="view-records-btn" class="flex-1 py-3 bg-gray-100/70 hover:bg-gray-200/70 text-neutral rounded-lg transition-all duration-200 shadow-sm theme-transition">
            查看战绩
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 失败弹窗 -->
  <div id="fail-modal" class="fixed inset-0 bg-black/20 flex items-center justify-center z-50 hidden backdrop-blur-sm theme-transition">
    <div class="glass-effect rounded-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="fail-modal-content">
      <div class="text-center">
        <div class="w-16 h-16 bg-danger/20 rounded-full flex items-center justify-center mx-auto mb-4 theme-transition">
          <i class="fa fa-times-circle text-2xl text-danger"></i>
        </div>
        <h3 class="text-xl font-bold text-neutral mb-2 theme-transition">很遗憾，次数用完了！</h3>
        <p class="text-gray-600 mb-4 theme-transition">正确答案是：<span id="fail-target-number" class="font-bold text-primary">0</span></p>
        <p class="text-gray-600 mb-6 theme-transition">再接再厉，下次一定能猜对！</p>
        <div class="flex gap-3">
          <button id="try-again-btn" class="flex-1 py-3 bg-primary hover:bg-primary/90 text-white rounded-lg transition-all duration-200 shadow-md hover:shadow-primary/30 theme-transition">
            再试一次
          </button>
          <button id="close-fail-modal-btn" class="flex-1 py-3 bg-gray-100/70 hover:bg-gray-200/70 text-neutral rounded-lg transition-all duration-200 shadow-sm theme-transition">
            关闭
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 战绩弹窗 -->
  <div id="records-modal" class="fixed inset-0 bg-black/20 flex items-center justify-center z-50 hidden backdrop-blur-sm theme-transition">
    <div class="glass-effect rounded-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="records-modal-content">
      <div class="flex justify-between items-start mb-4">
        <h3 class="text-xl font-bold text-neutral flex items-center gap-2 theme-transition">
          <i class="fa fa-bar-chart text-primary"></i>
          游戏战绩
        </h3>
        <button id="close-records-modal" class="text-gray-400 hover:text-gray-600 transition-colors theme-transition">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div id="records-list" class="max-h-60 overflow-y-auto mb-6 space-y-3">
        <p class="text-gray-500 text-center py-4 theme-transition">暂无游戏记录</p>
      </div>
      <button id="clear-records-btn" class="w-full py-2 text-danger hover:text-danger/80 transition-colors theme-transition">
        <i class="fa fa-trash-o mr-1"></i> 清空记录
      </button>
    </div>
  </div>

  <script>
    // 初始化LeanCloud
    AV.init({
      appId: "N22Ib3WihnpW82odMgkJdzWI-gzGzoHsz",
      appKey: "rhqaqcH0YVrAwZvAfgJVGHcW",
      serverURL: "https://N22Ib3WihnpW82odMgkJdzWI-gzGzoHsz.lc-cn-n1-shared.com"
    });
    
    // 定义数据模型
    const GameUser = AV.Object.extend('GameUser');
    const GameRecord = AV.Object.extend('GameRecord');
    
    // 游戏变量
    let targetNumber;
    let guessCount = 0;
    let gameActive = true;
    let isDarkMode = false;
    let difficulty = "normal";
    const MAX_GUESS_NORMAL = 10;
    const MAX_GUESS_HARD = 5;
    let currentUser = null;
    let themeIcon;
    
    // DOM元素
    const authModal = document.getElementById('auth-modal');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const switchToRegister = document.getElementById('switch-to-register');
    const switchToLogin = document.getElementById('switch-to-login');
    const loginUsername = document.getElementById('login-username');
    const loginPassword = document.getElementById('login-password');
    const loginBtn = document.getElementById('login-btn');
    const loginError = document.getElementById('login-error');
    const registerUsername = document.getElementById('register-username');
    const registerPassword = document.getElementById('register-password');
    const registerConfirmPassword = document.getElementById('register-confirm-password');
    const registerBtn = document.getElementById('register-btn');
    const registerError = document.getElementById('register-error');
    const registerSuccess = document.getElementById('register-success');
    const header = document.getElementById('header');
    const mainContent = document.querySelector('main');
    const footer = document.getElementById('footer');
    const usernameDisplay = document.getElementById('username-display');
    const logoutBtn = document.getElementById('logout-btn');
    const adminBtn = document.getElementById('admin-btn');
    const adminPanel = document.getElementById('admin-panel');
    const closeAdminPanel = document.getElementById('close-admin-panel');
    const searchUser = document.getElementById('search-user');
    const userList = document.getElementById('user-list');
    const userRecords = document.getElementById('user-records');
    const currentUserRecordsTitle = document.getElementById('current-user-records-title');
    const changePasswordModal = document.getElementById('change-password-modal');
    const changePasswordContent = document.getElementById('change-password-content');
    const closePasswordModal = document.getElementById('close-password-modal');
    const targetUserId = document.getElementById('target-user-id');
    const newPassword = document.getElementById('new-password');
    const confirmNewPassword = document.getElementById('confirm-new-password');
    const passwordError = document.getElementById('password-error');
    const savePasswordBtn = document.getElementById('save-password-btn');
    
    // 新增：管理员功能DOM元素
    const adminSelfPassword = document.getElementById('admin-self-password');
    const changeSelfPasswordBtn = document.getElementById('change-self-password-btn');
    const selfPasswordError = document.getElementById('self-password-error');
    const addAdminUsername = document.getElementById('add-admin-username');
    const addAdminBtn = document.getElementById('add-admin-btn');
    const addAdminError = document.getElementById('add-admin-error');
    const addAdminSuccess = document.getElementById('add-admin-success');
    
    const guessInput = document.getElementById('guess-input');
    const guessBtn = document.getElementById('guess-btn');
    const resetBtn = document.getElementById('reset-btn');
    const resultMessage = document.getElementById('result-message');
    const guessCountElement = document.getElementById('guess-count');
    const remainingCountElement = document.getElementById('remaining-count');
    const remainingCountArea = document.getElementById('remaining-count-area');
    const remainingIcon = document.getElementById('remaining-icon');
    const remainingText = document.getElementById('remaining-text');
    const guessHistory = document.getElementById('guess-history');
    const successModal = document.getElementById('success-modal');
    const modalContent = document.getElementById('modal-content');
    const finalCountElement = document.getElementById('final-count');
    const playAgainBtn = document.getElementById('play-again-btn');
    const viewRecordsBtn = document.getElementById('view-records-btn');
    const helpBtn = document.getElementById('help-btn');
    const rulesCard = document.getElementById('rules-card');
    const closeRulesBtn = document.getElementById('close-rules');
    const themeToggle = document.getElementById('theme-toggle');
    const body = document.body;
    const gameCard = document.getElementById('game-card');
    const difficultyToggle = document.getElementById('difficulty-toggle');
    const difficultyText = document.getElementById('difficulty-text');
    const failModal = document.getElementById('fail-modal');
    const failModalContent = document.getElementById('fail-modal-content');
    const failTargetNumber = document.getElementById('fail-target-number');
    const tryAgainBtn = document.getElementById('try-again-btn');
    const closeFailModalBtn = document.getElementById('close-fail-modal-btn');
    const recordsBtn = document.getElementById('records-btn');
    const recordsModal = document.getElementById('records-modal');
    const recordsModalContent = document.getElementById('records-modal-content');
    const recordsList = document.getElementById('records-list');
    const closeRecordsModal = document.getElementById('close-records-modal');
    const clearRecordsBtn = document.getElementById('clear-records-btn');
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', () => {
        themeIcon = document.getElementById('theme-toggle').querySelector('i');
        
        // 切换登录/注册表单
        switchToRegister.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            clearAuthErrors();
        });
        
        switchToLogin.addEventListener('click', () => {
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            clearAuthErrors();
        });
        
        // 登录按钮事件
        loginBtn.addEventListener('click', async () => {
            const username = loginUsername.value.trim();
            const password = loginPassword.value.trim();
            
            if (!username || !password) {
                showAuthError('login', '请输入用户名和密码');
                return;
            }
            
            try {
                const query = new AV.Query(GameUser);
                query.equalTo('username', username);
                const user = await query.first();
                
                if (!user) {
                    showAuthError('login', '用户名不存在');
                    return;
                }
                
                if (user.get('password') !== password) {
                    showAuthError('login', '密码错误');
                    return;
                }
                
                // 登录成功
                currentUser = { 
                    id: user.id, 
                    username: user.get('username'),
                    role: user.get('role') || 'user'
                };
                
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                authModal.classList.add('hidden');
                header.style.display = 'block';
                mainContent.style.display = 'flex';
                footer.style.display = 'block';
                usernameDisplay.textContent = currentUser.username;
                
                // 如果是管理员，显示管理员按钮
                if (currentUser.role === 'admin') {
                    adminBtn.classList.remove('hidden');
                    loadAllUsers();
                }
                
                initGame();
            } catch (error) {
                console.error('登录失败:', error);
                showAuthError('login', `登录失败：${error.message || '网络异常'}`);
            }
        });
        
        // 注册按钮事件
        registerBtn.addEventListener('click', async () => {
            const username = registerUsername.value.trim();
            const password = registerPassword.value.trim();
            const confirmPwd = registerConfirmPassword.value.trim();
            
            if (!username || !password || !confirmPwd) {
                showAuthError('register', '请填写完整信息');
                return;
            }
            
            if (password !== confirmPwd) {
                showAuthError('register', '两次密码不一致');
                return;
            }
            
            if (password.length < 6) {
                showAuthError('register', '密码长度不能少于6位');
                return;
            }
            
            try {
                const query = new AV.Query(GameUser);
                query.equalTo('username', username);
                const existingUser = await query.first();
                
                if (existingUser) {
                    showAuthError('register', '用户名已被占用');
                    return;
                }
                
                const newUser = new GameUser();
                newUser.set('username', username);
                newUser.set('password', password);
                newUser.set('role', 'user'); // 默认普通用户
                await newUser.save();
                
                registerSuccess.textContent = '注册成功！3秒后跳转到登录';
                registerSuccess.classList.remove('hidden');
                
                setTimeout(() => {
                    registerForm.classList.add('hidden');
                    loginForm.classList.remove('hidden');
                    loginUsername.value = username;
                    clearAuthErrors();
                }, 3000);
            } catch (error) {
                console.error('注册失败:', error);
                showAuthError('register', `注册失败：${error.message || '网络异常'}`);
            }
        });
        
        // 退出登录
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('currentUser');
            window.location.reload();
        });
        
        // 管理员面板相关
        adminBtn.addEventListener('click', () => {
            adminPanel.classList.remove('hidden');
            setTimeout(() => {
                adminPanel.querySelector('div').classList.remove('scale-95', 'opacity-0');
                adminPanel.querySelector('div').classList.add('scale-100', 'opacity-100');
            }, 10);
        });
        
        closeAdminPanel.addEventListener('click', () => {
            const panelContent = adminPanel.querySelector('div');
            panelContent.classList.remove('scale-100', 'opacity-100');
            panelContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                adminPanel.classList.add('hidden');
            }, 300);
        });
        
        // 搜索用户
        searchUser.addEventListener('input', debounce(async (e) => {
            const searchTerm = e.target.value.trim().toLowerCase();
            await loadAllUsers(searchTerm);
        }, 300));
        
        // 修改密码弹窗相关
        closePasswordModal.addEventListener('click', () => {
            changePasswordContent.classList.remove('scale-100', 'opacity-100');
            changePasswordContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                changePasswordModal.classList.add('hidden');
                newPassword.value = '';
                confirmNewPassword.value = '';
                passwordError.textContent = '';
                passwordError.classList.add('hidden');
            }, 300);
        });
        
        savePasswordBtn.addEventListener('click', async () => {
            const userId = targetUserId.value;
            const password = newPassword.value.trim();
            const confirmPwd = confirmNewPassword.value.trim();
            
            if (!password || !confirmPwd) {
                passwordError.textContent = '请输入密码';
                passwordError.classList.remove('hidden');
                return;
            }
            
            if (password !== confirmPwd) {
                passwordError.textContent = '两次密码不一致';
                passwordError.classList.remove('hidden');
                return;
            }
            
            if (password.length < 6) {
                passwordError.textContent = '密码长度不能少于6位';
                passwordError.classList.remove('hidden');
                return;
            }
            
            try {
                const user = AV.Object.createWithoutData('GameUser', userId);
                user.set('password', password);
                await user.save();
                
                // 关闭弹窗并刷新用户列表
                changePasswordContent.classList.remove('scale-100', 'opacity-100');
                changePasswordContent.classList.add('scale-95', 'opacity-0');
                
                setTimeout(() => {
                    changePasswordModal.classList.add('hidden');
                    newPassword.value = '';
                    confirmNewPassword.value = '';
                    passwordError.textContent = '';
                    passwordError.classList.add('hidden');
                    loadAllUsers();
                }, 300);
                
                alert('密码修改成功');
            } catch (error) {
                console.error('修改密码失败:', error);
                passwordError.textContent = `修改失败：${error.message || '网络异常'}`;
                passwordError.classList.remove('hidden');
            }
        });
        
        // 新增：修改自身密码功能
        changeSelfPasswordBtn.addEventListener('click', async () => {
            const newPassword = adminSelfPassword.value.trim();
            
            if (!newPassword) {
                showSelfPasswordError('请输入新密码');
                return;
            }
            
            if (newPassword.length < 6) {
                showSelfPasswordError('密码长度不能少于6位');
                return;
            }
            
            try {
                // 获取当前用户对象
                const query = new AV.Query(GameUser);
                const currentUserObj = await query.get(currentUser.id);
                
                // 更新密码
                currentUserObj.set('password', newPassword);
                await currentUserObj.save();
                
                // 清空输入框并显示成功消息
                adminSelfPassword.value = '';
                selfPasswordError.textContent = '';
                selfPasswordError.classList.add('hidden');
                
                // 显示成功提示
                showTempMessage('密码修改成功！', 'success');
                
            } catch (error) {
                console.error('修改密码失败:', error);
                showSelfPasswordError(`修改失败：${error.message || '网络异常'}`);
            }
        });
        
        // 新增：添加管理员权限功能
        addAdminBtn.addEventListener('click', async () => {
            const username = addAdminUsername.value.trim();
            
            if (!username) {
                showAddAdminError('请输入用户名');
                return;
            }
            
            // 不能将自己重复设置为管理员
            if (username === currentUser.username) {
                showAddAdminError('您已经是管理员');
                return;
            }
            
            try {
                // 查找目标用户
                const query = new AV.Query(GameUser);
                query.equalTo('username', username);
                const targetUser = await query.first();
                
                if (!targetUser) {
                    showAddAdminError('用户不存在');
                    return;
                }
                
                // 检查是否已经是管理员
                if (targetUser.get('role') === 'admin') {
                    showAddAdminError('该用户已经是管理员');
                    return;
                }
                
                // 确认操作
                if (!confirm(`确定要将用户 "${username}" 设置为管理员吗？\n\n管理员拥有以下权限：\n• 查看所有用户信息\n• 修改用户密码\n• 删除用户账号\n• 查看用户战绩`)) {
                    return;
                }
                
                // 更新用户角色为管理员
                targetUser.set('role', 'admin');
                await targetUser.save();
                
                // 清空输入框并显示成功消息
                addAdminUsername.value = '';
                addAdminError.textContent = '';
                addAdminError.classList.add('hidden');
                
                // 显示成功消息
                addAdminSuccess.textContent = `用户 "${username}" 已成功设置为管理员`;
                addAdminSuccess.classList.remove('hidden');
                
                // 刷新用户列表
                loadAllUsers();
                
                // 3秒后隐藏成功消息
                setTimeout(() => {
                    addAdminSuccess.textContent = '';
                    addAdminSuccess.classList.add('hidden');
                }, 3000);
                
            } catch (error) {
                console.error('添加管理员失败:', error);
                showAddAdminError(`操作失败：${error.message || '网络异常'}`);
            }
        });
        
        // 游戏初始化
        function initGame() {
            targetNumber = Math.floor(Math.random() * 100) + 1;
            guessCount = 0;
            gameActive = true;
            guessInput.value = '';
            guessCountElement.textContent = '0';
            remainingCountElement.textContent = difficulty === 'normal' ? MAX_GUESS_NORMAL : MAX_GUESS_HARD;
            resultMessage.textContent = '';
            resultMessage.classList.add('hidden');
            guessHistory.innerHTML = '<span class="text-gray-400 text-sm theme-transition">暂无猜测记录</span>';
            guessInput.disabled = false;
            guessBtn.disabled = false;
            guessInput.focus();
            updateRemainingCount();
        }
        
        // 处理猜测
        guessBtn.addEventListener('click', handleGuess);
        guessInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleGuess();
        });
        
        function handleGuess() {
            if (!gameActive) return;
            
            const guessValue = parseInt(guessInput.value.trim());
            
            // 验证输入
            if (isNaN(guessValue) || guessValue < 1 || guessValue > 100) {
                showResult('请输入1-100之间的有效数字', 'bg-warning/20 text-warning');
                return;
            }
            
            guessCount++;
            guessCountElement.textContent = guessCount;
            
            // 更新剩余次数
            const maxGuesses = difficulty === 'normal' ? MAX_GUESS_NORMAL : MAX_GUESS_HARD;
            const remaining = maxGuesses - guessCount;
            remainingCountElement.textContent = remaining;
            updateRemainingCount();
            
            // 添加到历史记录
            updateGuessHistory(guessValue);
            
            // 检查猜测结果
            if (guessValue === targetNumber) {
                // 猜对了
                showResult('恭喜你，猜对了！', 'bg-accent/20 text-accent');
                gameActive = false;
                guessInput.disabled = true;
                guessBtn.disabled = true;
                saveGameRecord(true);
                showSuccessModal();
            } else if (guessCount >= maxGuesses) {
                // 次数用完
                showResult(`很遗憾，次数用完了！正确答案是${targetNumber}`, 'bg-danger/20 text-danger');
                gameActive = false;
                guessInput.disabled = true;
                guessBtn.disabled = true;
                saveGameRecord(false);
                showFailModal();
            } else if (guessValue < targetNumber) {
                // 太小
                showResult('猜小了，再试试更大的数字！', 'bg-primary/20 text-primary');
            } else {
                // 太大
                showResult('猜大了，再试试更小的数字！', 'bg-primary/20 text-primary');
            }
            
            guessInput.value = '';
            guessInput.focus();
        }
        
        // 显示结果
        function showResult(message, className) {
            resultMessage.textContent = message;
            resultMessage.className = `text-center px-4 py-2 rounded-lg result-animation ${className} theme-transition`;
            resultMessage.classList.remove('hidden');
            
            resultMessage.style.animation = 'none';
            setTimeout(() => {
                resultMessage.style.animation = '';
            }, 10);
        }
        
        // 更新猜测历史
        function updateGuessHistory(guess) {
            // 移除初始提示文本
            if (guessHistory.querySelector('.text-gray-400')) {
                guessHistory.innerHTML = '';
            }
            
            const historyItem = document.createElement('span');
            historyItem.className = `px-3 py-1 rounded-full text-sm font-medium ${
                guess < targetNumber ? 'bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400' : 
                guess > targetNumber ? 'bg-orange-100 text-orange-600 dark:bg-orange-900/30 dark:text-orange-400' : 
                'bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400'
            } theme-transition number-animation`;
            historyItem.textContent = guess;
            
            guessHistory.appendChild(historyItem);
        }
        
        // 更新剩余次数
        function updateRemainingCount() {
            const maxGuess = difficulty === 'normal' ? MAX_GUESS_NORMAL : MAX_GUESS_HARD;
            const remaining = maxGuess - guessCount;
            remainingCountElement.textContent = remaining;
            
            // 定义「不足」的阈值：普通模式≤3次，困难模式≤1次（可根据需求调整）
            const insufficientThreshold = difficulty === 'normal' ? 2 : 2;
            
            if (remaining <= insufficientThreshold) {
                // 次数不足：红色
                remainingCountArea.classList.remove('bg-accent/10'); // 移除绿色背景
                remainingCountArea.classList.add('bg-danger/10');    // 添加红色背景
                remainingIcon.classList.remove('text-accent');       // 移除绿色图标
                remainingIcon.classList.add('text-danger');          // 添加红色图标
                remainingText.classList.remove('text-accent');       // 移除绿色文字
                remainingText.classList.add('text-danger');          // 添加红色文字
            } else {
                // 次数充足：绿色
                remainingCountArea.classList.remove('bg-danger/10'); // 移除红色背景
                remainingCountArea.classList.add('bg-accent/10');    // 添加绿色背景（accent是配置的绿色#10B981）
                remainingIcon.classList.remove('text-danger');       // 移除红色图标
                remainingIcon.classList.add('text-accent');          // 添加绿色图标
                remainingText.classList.remove('text-danger');       // 移除红色文字
                remainingText.classList.add('text-accent');          // 添加绿色文字
            }
        }
        
        // 重置游戏
        resetBtn.addEventListener('click', initGame);
        
        // 胜利弹窗
        function showSuccessModal() {
            finalCountElement.textContent = guessCount;
            successModal.classList.remove('hidden');
            
            // 适配深色模式
            if (isDarkMode) {
                successModal.classList.add('bg-black/50');
                modalContent.classList.add('glass-effect-dark', 'card-shadow-dark');
                modalContent.classList.remove('glass-effect', 'card-shadow');
            } else {
                successModal.classList.remove('bg-black/50');
                modalContent.classList.add('glass-effect', 'card-shadow');
                modalContent.classList.remove('glass-effect-dark', 'card-shadow-dark');
            }
            
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }
        
        // 失败弹窗
        function showFailModal() {
            failTargetNumber.textContent = targetNumber;
            failModal.classList.remove('hidden');
            
            // 适配深色模式
            if (isDarkMode) {
                failModal.classList.add('bg-black/50');
                failModalContent.classList.add('glass-effect-dark', 'card-shadow-dark');
                failModalContent.classList.remove('glass-effect', 'card-shadow');
            } else {
                failModal.classList.remove('bg-black/50');
                failModalContent.classList.add('glass-effect', 'card-shadow');
                failModalContent.classList.remove('glass-effect-dark', 'card-shadow-dark');
            }
            
            setTimeout(() => {
                failModalContent.classList.remove('scale-95', 'opacity-0');
                failModalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }
        
        // 显示战绩弹窗
        function showRecordsModal() {
            recordsModal.classList.remove('hidden');
            loadUserRecords();
            
            // 适配深色模式
            if (isDarkMode) {
                recordsModal.classList.add('bg-black/50');
                recordsModalContent.classList.add('glass-effect-dark', 'card-shadow-dark');
                recordsModalContent.classList.remove('glass-effect', 'card-shadow');
            } else {
                recordsModal.classList.remove('bg-black/50');
                recordsModalContent.classList.add('glass-effect', 'card-shadow');
                recordsModalContent.classList.remove('glass-effect-dark', 'card-shadow-dark');
            }
            
            setTimeout(() => {
                recordsModalContent.classList.remove('scale-95', 'opacity-0');
                recordsModalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }
        
        // 确保战绩按钮能正常工作
        recordsBtn.addEventListener('click', showRecordsModal);
        
        // 关闭胜利弹窗
        playAgainBtn.addEventListener('click', () => {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                successModal.classList.add('hidden');
                initGame();
            }, 300);
        });
        
        viewRecordsBtn.addEventListener('click', () => {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                successModal.classList.add('hidden');
                showRecordsModal();
            }, 300);
        });
        
        // 关闭失败弹窗
        tryAgainBtn.addEventListener('click', () => {
            failModalContent.classList.remove('scale-100', 'opacity-100');
            failModalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                failModal.classList.add('hidden');
                initGame();
            }, 300);
        });
        
        closeFailModalBtn.addEventListener('click', () => {
            failModalContent.classList.remove('scale-100', 'opacity-100');
            failModalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                failModal.classList.add('hidden');
            }, 300);
        });
        
        // 关闭战绩弹窗
        closeRecordsModal.addEventListener('click', () => {
            recordsModalContent.classList.remove('scale-100', 'opacity-100');
            recordsModalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                recordsModal.classList.add('hidden');
            }, 300);
        });
        
        // 切换难度
        difficultyToggle.addEventListener('change', () => {
            difficulty = difficultyToggle.checked ? "hard" : "normal";
            difficultyText.textContent = difficulty === "normal" ? "普通" : "困难";
            initGame();
        });
        
        // 帮助按钮
        helpBtn.addEventListener('click', () => {
            rulesCard.classList.toggle('hidden');
        });
        
        closeRulesBtn.addEventListener('click', () => {
            rulesCard.classList.add('hidden');
        });
        
        // 清空战绩
        clearRecordsBtn.addEventListener('click', async () => {
            if (confirm('确定要清空所有战绩记录吗？')) {
                try {
                    const query = new AV.Query(GameRecord);
                    query.equalTo('user', AV.Object.createWithoutData('GameUser', currentUser.id));
                    const records = await query.find();
                    
                    if (records.length > 0) {
                        await AV.Object.destroyAll(records);
                        loadUserRecords();
                    }
                } catch (error) {
                    console.error('清空记录失败:', error);
                    alert('清空记录失败: ' + error.message);
                }
            }
        });
        
        // 切换主题
        themeToggle.addEventListener('click', toggleTheme);
        
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            body.classList.toggle('dark-theme', isDarkMode);
            
            if (isDarkMode) {
                // 切换到深色模式
                themeIcon.classList.remove('fa-moon-o');
                themeIcon.classList.add('fa-sun-o');
                
                // 更新游戏卡片样式
                gameCard.classList.remove('glass-effect', 'card-shadow');
                gameCard.classList.add('glass-effect-dark', 'card-shadow-dark');
                
                // 更新规则卡片样式
                rulesCard.classList.remove('glass-effect', 'card-shadow');
                rulesCard.classList.add('glass-effect-dark', 'card-shadow-dark');
                
                // 更新顶部导航样式
                header.classList.remove('glass-effect');
                header.classList.add('glass-effect-dark');
                
                // 更新底部样式
                footer.classList.remove('glass-effect');
                footer.classList.add('glass-effect-dark');
                
                // 更新弹窗样式
                successModal.classList.add('bg-black/50');
                modalContent.classList.remove('glass-effect', 'card-shadow');
                modalContent.classList.add('glass-effect-dark', 'card-shadow-dark');
                
                failModal.classList.add('bg-black/50');
                failModalContent.classList.remove('glass-effect', 'card-shadow');
                failModalContent.classList.add('glass-effect-dark', 'card-shadow-dark');
                
                recordsModal.classList.add('bg-black/50');
                recordsModalContent.classList.remove('glass-effect', 'card-shadow');
                recordsModalContent.classList.add('glass-effect-dark', 'card-shadow-dark');
                
                adminPanel.classList.add('bg-black/50');
                adminPanel.querySelector('div').classList.remove('glass-effect', 'card-shadow');
                adminPanel.querySelector('div').classList.add('glass-effect-dark', 'card-shadow-dark');
                
                changePasswordModal.classList.add('bg-black/50');
                changePasswordContent.classList.remove('glass-effect', 'card-shadow');
                changePasswordContent.classList.add('glass-effect-dark', 'card-shadow-dark');
                
            } else {
                // 切换到白天模式
                themeIcon.classList.remove('fa-sun-o');
                themeIcon.classList.add('fa-moon-o');
                
                // 更新游戏卡片样式
                gameCard.classList.remove('glass-effect-dark', 'card-shadow-dark');
                gameCard.classList.add('glass-effect', 'card-shadow');
                
                // 更新规则卡片样式
                rulesCard.classList.remove('glass-effect-dark', 'card-shadow-dark');
                rulesCard.classList.add('glass-effect', 'card-shadow');
                
                // 更新顶部导航样式
                header.classList.remove('glass-effect-dark');
                header.classList.add('glass-effect');
                
                // 更新底部样式
                footer.classList.remove('glass-effect-dark');
                footer.classList.add('glass-effect');
                
                // 更新弹窗样式
                successModal.classList.remove('bg-black/50');
                modalContent.classList.remove('glass-effect-dark', 'card-shadow-dark');
                modalContent.classList.add('glass-effect', 'card-shadow');
                
                failModal.classList.remove('bg-black/50');
                failModalContent.classList.remove('glass-effect-dark', 'card-shadow-dark');
                failModalContent.classList.add('glass-effect', 'card-shadow');
                
                recordsModal.classList.remove('bg-black/50');
                recordsModalContent.classList.remove('glass-effect-dark', 'card-shadow-dark');
                recordsModalContent.classList.add('glass-effect', 'card-shadow');
                
                adminPanel.classList.remove('bg-black/50');
                adminPanel.querySelector('div').classList.remove('glass-effect-dark', 'card-shadow-dark');
                adminPanel.querySelector('div').classList.add('glass-effect', 'card-shadow');
                
                changePasswordModal.classList.remove('bg-black/50');
                changePasswordContent.classList.remove('glass-effect-dark', 'card-shadow-dark');
                changePasswordContent.classList.add('glass-effect', 'card-shadow');
            }
            
            // 保存主题设置到本地存储
            localStorage.setItem('darkMode', isDarkMode);
            
            // 更新历史记录项的样式
            updateHistoryItemsStyle();
        }
        
        // 更新历史记录项的样式（深色模式适配）
        function updateHistoryItemsStyle() {
            const items = guessHistory.querySelectorAll('span');
            items.forEach(item => {
                if (isDarkMode) {
                    item.classList.remove('bg-blue-100', 'text-blue-600', 'bg-orange-100', 'text-orange-600', 'bg-green-100', 'text-green-600');
                    item.classList.add('dark:bg-blue-900/30', 'dark:text-blue-400', 'dark:bg-orange-900/30', 'dark:text-orange-400', 'dark:bg-green-900/30', 'dark:text-green-400');
                } else {
                    item.classList.remove('dark:bg-blue-900/30', 'dark:text-blue-400', 'dark:bg-orange-900/30', 'dark:text-orange-400', 'dark:bg-green-900/30', 'dark:text-green-400');
                    item.classList.add('bg-blue-100', 'text-blue-600', 'bg-orange-100', 'text-orange-600', 'bg-green-100', 'text-green-600');
                }
            });
        }
        
        // 难度切换
        difficultyToggle.addEventListener('change', () => {
            if (difficultyToggle.checked) {
                difficulty = 'hard';
                difficultyText.textContent = '困难';
            } else {
                difficulty = 'normal';
                difficultyText.textContent = '普通';
            }
            initGame();
        });
        
        // 主题切换 - 已合并到toggleTheme函数
        
        // 帮助按钮 - 已处理
        
        // 战绩相关
        recordsBtn.addEventListener('click', () => {
            loadUserRecords();
            recordsModal.classList.remove('hidden');
            
            setTimeout(() => {
                recordsModalContent.classList.remove('scale-95', 'opacity-0');
                recordsModalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        });
        
        viewRecordsBtn.addEventListener('click', () => {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                successModal.classList.add('hidden');
                loadUserRecords();
                recordsModal.classList.remove('hidden');
                
                setTimeout(() => {
                    recordsModalContent.classList.remove('scale-95', 'opacity-0');
                    recordsModalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            }, 300);
        });
        
        closeRecordsModal.addEventListener('click', () => {
            recordsModalContent.classList.remove('scale-100', 'opacity-100');
            recordsModalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                recordsModal.classList.add('hidden');
            }, 300);
        });
        
        clearRecordsBtn.addEventListener('click', async () => {
            if (!confirm('确定要清空所有游戏记录吗？此操作不可恢复！')) {
                return;
            }
            
            try {
                const query = new AV.Query(GameRecord);
                query.equalTo('user', AV.Object.createWithoutData('GameUser', currentUser.id));
                const records = await query.find();
                
                if (records.length > 0) {
                    await AV.Object.destroyAll(records);
                    loadUserRecords();
                }
            } catch (error) {
                console.error('清空记录失败:', error);
                alert('清空记录失败，请稍后再试');
            }
        });
        
        // 保存游戏记录
        async function saveGameRecord(isSuccess) {
            if (!currentUser) return;
            
            try {
                const record = new GameRecord();
                record.set('user', AV.Object.createWithoutData('GameUser', currentUser.id));
                record.set('isSuccess', isSuccess);
                record.set('guessCount', guessCount);
                record.set('targetNumber', targetNumber);
                record.set('difficulty', difficulty);
                record.set('date', new Date());
                
                await record.save();
            } catch (error) {
                console.error('保存记录失败:', error);
            }
        }
        
        // 加载用户战绩
        async function loadUserRecords(targetUserId = null) {
            // 确定要加载的用户ID
            const userIdToLoad = targetUserId || (currentUser ? currentUser.id : null);
            
            if (!userIdToLoad) {
                recordsList.innerHTML = '<p class="text-gray-500 text-center py-4 theme-transition">用户未登录</p>';
                return;
            }
            
            try {
                const query = new AV.Query(GameRecord);
                query.equalTo('user', AV.Object.createWithoutData('GameUser', userIdToLoad));
                query.descending('date');
                query.limit(10);
                const records = await query.find();
                
                if (records.length === 0) {
                    recordsList.innerHTML = '<p class="text-gray-500 text-center py-4 theme-transition">暂无游戏记录</p>';
                    return;
                }
                
                recordsList.innerHTML = '';
                records.forEach(record => {
                    const item = document.createElement('div');
                    item.className = 'record-item theme-transition';
                    
                    const date = new Date(record.get('date'));
                    const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                    
                    item.innerHTML = `
                        <div class="record-date theme-transition">${formattedDate} · ${record.get('difficulty') === 'normal' ? '普通模式' : '困难模式'}</div>
                        <div class="record-stats">
                            <span>猜测次数: ${record.get('guessCount')}</span>
                            <span class="${record.get('isSuccess') ? 'record-success' : 'record-fail'}">${record.get('isSuccess') ? '成功' : '失败'}</span>
                        </div>
                    `;
                    
                    recordsList.appendChild(item);
                });
            } catch (error) {
                console.error('加载记录失败:', error);
                recordsList.innerHTML = '<p class="text-red-500 text-center py-4 theme-transition">加载记录失败</p>';
            }
        }
        
        // 加载所有用户（管理员功能）
        async function loadAllUsers(searchTerm = '') {
            try {
                const query = new AV.Query(GameUser);
                if (searchTerm) {
                    query.contains('username', searchTerm);
                }
                const users = await query.find();
                
                userList.innerHTML = '';
                users.forEach(user => {
                    // 管理员不能删除自己
                    const isCurrentUser = currentUser && user.id === currentUser.id;
                    
                    const userItem = document.createElement('div');
                    userItem.className = 'flex justify-between items-center p-3 bg-white/60 dark:bg-gray-800/60 rounded-lg cursor-pointer hover:bg-gray-100/60 dark:hover:bg-gray-700/60 transition-colors theme-transition';
                    userItem.innerHTML = `
                        <div class="flex items-center gap-2">
                            <i class="fa fa-user ${user.get('role') === 'admin' ? 'text-primary' : 'text-gray-500'} theme-transition"></i>
                            <span class="theme-transition">
                                ${user.get('username')} 
                                ${user.get('role') === 'admin' ? 
                                    '<span class="text-xs bg-primary/10 text-primary px-2 py-0.5 rounded-full ml-2">管理员</span>' : 
                                    '<span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full ml-2">普通用户</span>'
                                }
                            </span>
                        </div>
                        <div class="flex gap-1">
                            <button class="view-records-btn p-1.5 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" data-user-id="${user.id}" data-username="${user.get('username')}">
                                <i class="fa fa-history text-gray-500 theme-transition"></i>
                            </button>
                            <button class="edit-password-btn p-1.5 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors ${isCurrentUser ? 'opacity-50 cursor-not-allowed' : ''}" data-user-id="${user.id}" ${isCurrentUser ? 'disabled' : ''}>
                                <i class="fa fa-key text-gray-500 theme-transition"></i>
                            </button>
${user.get('role') !== 'admin' ? `
                                <button class="promote-admin-btn p-1.5 rounded-full hover:bg-yellow-200 dark:hover:bg-yellow-700 transition-colors" data-user-id="${user.id}" data-username="${user.get('username')}">
                                    <i class="fa fa-star text-yellow-500 theme-transition"></i>
                                </button>
                            ` : ''}
                    <button class="delete-user-btn p-1.5 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors ${isCurrentUser ? 'opacity-50 cursor-not-allowed' : ''}" data-user-id="${user.id}" data-username="${user.get('username')}" ${isCurrentUser ? 'disabled' : ''}>
                        <i class="fa fa-trash text-gray-500 theme-transition"></i>
                    </button>
                </div>
            `;
            
            userList.appendChild(userItem);
                    
                    // 查看用户战绩
                    userItem.querySelector('.view-records-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        const userId = e.currentTarget.getAttribute('data-user-id');
                        const username = e.currentTarget.getAttribute('data-username');
                        currentUserRecordsTitle.textContent = `${username} 的战绩`;
                        
                        // 清空现有内容，显示加载中
                        userRecords.innerHTML = '<p class="text-gray-500 text-center py-4 theme-transition">加载中...</p>';
                        
                        // 加载对应用户的战绩记录
                        loadUserRecordsForAdminPanel(userId, username);
                    });
                    
                    // 修改用户密码
                    const editBtn = userItem.querySelector('.edit-password-btn');
                    if (!isCurrentUser) {
                        editBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const userId = e.currentTarget.getAttribute('data-user-id');
                            targetUserId.value = userId;
                            changePasswordModal.classList.remove('hidden');
                            
                            // 适配深色模式
                            if (isDarkMode) {
                                changePasswordModal.classList.add('bg-black/50');
                                changePasswordContent.classList.add('glass-effect-dark', 'card-shadow-dark');
                                changePasswordContent.classList.remove('glass-effect', 'card-shadow');
                            } else {
                                changePasswordModal.classList.remove('bg-black/50');
                                changePasswordContent.classList.add('glass-effect', 'card-shadow');
                                changePasswordContent.classList.remove('glass-effect-dark', 'card-shadow-dark');
                            }
                            
                            setTimeout(() => {
                                changePasswordContent.classList.remove('scale-95', 'opacity-0');
                                changePasswordContent.classList.add('scale-100', 'opacity-100');
                            }, 10);
                        });
                    }
                    
                    // 提升为管理员
                    if (user.get('role') !== 'admin') {
                        const promoteBtn = userItem.querySelector('.promote-admin-btn');
                        promoteBtn.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            const userId = e.currentTarget.getAttribute('data-user-id');
                            const username = e.currentTarget.getAttribute('data-username');
                            
                            if (!confirm(`确定要将用户 "${username}" 提升为管理员吗？`)) {
                                return;
                            }
                            
                            try {
                                const userToPromote = AV.Object.createWithoutData('GameUser', userId);
                                userToPromote.set('role', 'admin');
                                await userToPromote.save();
                                
                                // 刷新用户列表
                                loadAllUsers(searchTerm);
                                showTempMessage(`用户 "${username}" 已成功提升为管理员`, 'success');
                            } catch (error) {
                                console.error('提升管理员失败:', error);
                                alert(`操作失败：${error.message || '网络异常'}`);
                            }
                        });
                    }
                    
                    // 删除用户
                    const deleteBtn = userItem.querySelector('.delete-user-btn');
                    if (!isCurrentUser) {
                        // 找到删除用户的事件监听代码（约第1550行左右），替换为：
deleteBtn.addEventListener('click', async (e) => {
    e.stopPropagation();
    const userId = e.currentTarget.getAttribute('data-user-id');
    const username = e.currentTarget.getAttribute('data-username');
    
    if (!confirm(`确定要删除用户 "${username}" 吗？此操作将同时删除该用户的所有游戏记录！`)) {
        return;
    }
    
    try {
        // 1. 先检查当前用户是否为管理员（双重验证）
        if (currentUser?.role !== 'admin') {
            alert('无权限执行此操作！');
            return;
        }
        
        // 2. 先删除用户的所有游戏记录（确保异步完成）
        const recordQuery = new AV.Query(GameRecord);
        recordQuery.equalTo('user', AV.Object.createWithoutData('GameUser', userId));
        const records = await recordQuery.find();
        
        if (records.length > 0) {
            await AV.Object.destroyAll(records); // 等待记录删除完成
        }
        
        // 3. 再删除用户（必须用 AV.User 类删除，而非 AV.Object）
        const userToDelete = AV.Object.createWithoutData('GameUser', userId);
        // 关键修复：添加权限头（如果 LeanCloud 开启了权限控制）
        const deleteResult = await userToDelete.destroy({
            headers: {
                'X-LC-Session': AV.User.current()?._sessionToken // 传递管理员会话令牌
            }
        });
        
        // 4. 刷新列表（确保DOM操作在删除成功后）
        loadAllUsers(searchTerm);
        userRecords.innerHTML = '<p class="text-gray-500 text-center py-4 theme-transition">请选择一个用户查看战绩</p>';
        
        alert(`用户 "${username}" 已成功删除`);
    } catch (error) {
        console.error('删除用户失败:', error.response || error.message);
        // 错误提示优化：显示具体原因
        if (error.response?.status === 403) {
            alert('删除失败：权限不足，请检查 LeanCloud 数据权限配置');
        } else if (error.response?.status === 404) {
            alert('删除失败：用户不存在');
        } else {
            alert(`删除失败：${error.message || '网络异常，请重试'}`);
        }
    }
});
            } catch (error) {
                console.error('加载用户失败:', error);
                userList.innerHTML = '<p class="text-red-500 text-center py-4 theme-transition">加载用户失败</p>';
            }
        }
        
        // 新增函数：专门为管理员面板加载用户战绩
        async function loadUserRecordsForAdminPanel(userId, username = '') {
            try {
                const query = new AV.Query(GameRecord);
                query.equalTo('user', AV.Object.createWithoutData('GameUser', userId));
                query.descending('date');
                query.limit(10);
                const records = await query.find();
                
                if (records.length === 0) {
                    userRecords.innerHTML = `<p class="text-gray-500 text-center py-4 theme-transition">${username || '该用户'}暂无游戏记录</p>`;
                    return;
                }
                
                userRecords.innerHTML = '';
                records.forEach(record => {
                    const item = document.createElement('div');
                    item.className = 'record-item theme-transition';
                    
                    const date = new Date(record.get('date'));
                    const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                    
                    item.innerHTML = `
                        <div class="record-date theme-transition">${formattedDate} · ${record.get('difficulty') === 'normal' ? '普通模式' : '困难模式'}</div>
                        <div class="record-stats">
                            <span>猜测次数: ${record.get('guessCount')}</span>
                            <span class="${record.get('isSuccess') ? 'record-success' : 'record-fail'}">${record.get('isSuccess') ? '成功' : '失败'}</span>
                        </div>
                    `;
                    
                    userRecords.appendChild(item);
                });
            } catch (error) {
                console.error('加载用户战绩失败:', error);
                userRecords.innerHTML = '<p class="text-red-500 text-center py-4 theme-transition">加载战绩失败</p>';
            }
        }
        
        // 工具函数：清除认证错误信息
        function clearAuthErrors() {
            loginError.textContent = '';
            loginError.classList.add('hidden');
            registerError.textContent = '';
            registerError.classList.add('hidden');
            registerSuccess.textContent = '';
            registerSuccess.classList.add('hidden');
        }
        
        // 工具函数：显示认证错误信息
        function showAuthError(type, message) {
            clearAuthErrors();
            
            if (type === 'login') {
                loginError.textContent = message;
                loginError.classList.remove('hidden');
            } else {
                registerError.textContent = message;
                registerError.classList.remove('hidden');
            }
        }
        
        // 工具函数：显示自身密码错误
        function showSelfPasswordError(message) {
            selfPasswordError.textContent = message;
            selfPasswordError.classList.remove('hidden');
            
            // 3秒后自动隐藏错误消息
            setTimeout(() => {
                selfPasswordError.textContent = '';
                selfPasswordError.classList.add('hidden');
            }, 3000);
        }
        
        // 工具函数：显示添加管理员错误
        function showAddAdminError(message) {
            addAdminError.textContent = message;
            addAdminError.classList.remove('hidden');
            addAdminSuccess.textContent = '';
            addAdminSuccess.classList.add('hidden');
            
            // 3秒后自动隐藏错误消息
            setTimeout(() => {
                addAdminError.textContent = '';
                addAdminError.classList.add('hidden');
            }, 3000);
        }
        
        // 工具函数：显示临时消息
        function showTempMessage(message, type = 'info') {
            // 创建一个临时提示元素
            const tempMsg = document.createElement('div');
            tempMsg.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-blue-500 text-white'
            }`;
            tempMsg.textContent = message;
            tempMsg.style.transform = 'translateX(100%)';
            
            document.body.appendChild(tempMsg);
            
            // 显示动画
            setTimeout(() => {
                tempMsg.style.transform = 'translateX(0)';
            }, 10);
            
            // 3秒后隐藏并移除
            setTimeout(() => {
                tempMsg.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (tempMsg.parentNode) {
                        tempMsg.parentNode.removeChild(tempMsg);
                    }
                }, 300);
            }, 3000);
        }
        
        // 工具函数：防抖
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
        
        // 检查是否有已登录用户
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            authModal.classList.add('hidden');
            header.style.display = 'block';
            mainContent.style.display = 'flex';
            footer.style.display = 'block';
            usernameDisplay.textContent = currentUser.username;
            
            // 如果是管理员，显示管理员按钮
            if (currentUser && currentUser.role && currentUser.role.toLowerCase() === 'admin') {
                adminBtn.classList.remove('hidden');
                loadAllUsers();
                console.log('页面加载：管理员已登录，显示按钮');
            } else {
                adminBtn.classList.add('hidden');
                console.log('页面加载：非管理员，隐藏按钮');
            }
            
            initGame();
        }
        
        // 检查主题设置
        const savedTheme = localStorage.getItem('darkMode');
        if (savedTheme === 'true') {
            isDarkMode = true;
            body.classList.add('dark-theme');
            themeIcon.classList.remove('fa-moon-o');
            themeIcon.classList.add('fa-sun-o');
            toggleTheme(); // 应用深色模式样式
        }
    });
  </script>
</body>
</html>